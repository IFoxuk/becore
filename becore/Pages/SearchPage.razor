@page "/search"
@using becore.Services
@using becore.Components.ContentPreviewCard
@inject ContentApiService ContentService
@implements IDisposable

<style>
    .content-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        padding: 1rem 0;
        align-items: stretch;
    }
    
    .content-item {
        width: 100%;
        height: 300px;
        display: flex;
        flex-direction: column;
    }
    
    @@media (max-width: 992px) {
        .content-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
    }
    
    @@media (max-width: 576px) {
        .content-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .content-item {
            height: 280px;
        }
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }
    
    .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        color: #333;
        cursor: pointer;
        border-radius: 4px;
    }
    
    .pagination button:hover {
        background: #f0f0f0;
    }
    
    .pagination button.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
</style>

<Container Fluid>
    <Row Gap="Gap.Is4">
        <Column ColumnSize="ColumnSize.Is10.Is1.WithOffset" Border="Border.Rounded" Shadow="Shadow.Default" Background="Background.Primary" Padding="Padding.Is4">
            <Text TextSize="TextSize.Heading1" TextColor="TextColor.Secondary">Поиск модификаций</Text>
        </Column>

        <Column ColumnSize="ColumnSize.Is10.Is1.WithOffset" Border="Border.Rounded" Shadow="Shadow.Default" Background="Background.Primary" Padding="Padding.Is4">
            <Row>
                <Column ColumnSize="ColumnSize.Is8">
                    <Div Padding="Padding.Is4">
                        @if (_isLoading)
                        {
                            <Div Flex="Flex.JustifyContent.Center" Padding="Padding.Is4">
                                <Text TextSize="TextSize.Large" TextColor="TextColor.Primary">
                                    <Icon Name="IconName.Circle" Animation="Animation.Spin" />
                                    Поиск...
                                </Text>
                            </Div>
                        }
                        else if (_currentPageItems.Any())
                        {
                            <Div Margin="Margin.Is2.FromBottom">
                                <Text TextSize="TextSize.Small" TextColor="TextColor.Muted">
                                    Найдено результатов: @_totalResults (страница @_currentPage из @_totalPages)
                                </Text>
                            </Div>
                            
                            <div class="content-grid">
                                @foreach (var pageItem in _currentPageItems)
                                {
                                    <div class="content-item">
                                        <ContentPreviewCard 
                                            Title="@pageItem.Name" 
                                            Author="@GetFormattedDate(pageItem.Created)" 
                                            Tags="@pageItem.Tags" 
                                            Description="@GetDescription(pageItem.Description)" 
                                            ImageUrl="@GetImageUrl(pageItem.QuadIcon)" />
                                    </div>
                                }
                                
                                @* Заполняем пустые ячейки если нужно *@
                                @for (int i = _currentPageItems.Count(); i < PageSize; i++)
                                {
                                    <div class="content-item"></div>
                                }
                            </div>
                            
                            @if (_totalPages > 1)
                            {
                                <div class="pagination">
                                    @if (_currentPage > 1)
                                    {
                                        <button @onclick="() => ChangePage(_currentPage - 1)">Предыдущая</button>
                                    }
                                    
                                    @for (int i = Math.Max(1, _currentPage - 2); i <= Math.Min(_totalPages, _currentPage + 2); i++)
                                    {
                                        <button @onclick="() => ChangePage(i)" class="@(i == _currentPage ? "active" : "")">
                                            @i
                                        </button>
                                    }
                                    
                                    @if (_currentPage < _totalPages)
                                    {
                                        <button @onclick="() => ChangePage(_currentPage + 1)">Следующая</button>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <Div Flex="Flex.JustifyContent.Center" Padding="Padding.Is4">
                                <Text TextSize="TextSize.Large" TextColor="TextColor.Muted">
                                    <Icon Name="IconName.Search" />
                                    Ничего не найдено
                                </Text>
                            </Div>
                        }
                    </Div>
                </Column>

                <Column ColumnSize="ColumnSize.Is4">
                    <Div Padding="Padding.Is4" Background="Background.Secondary" Border="Border.Rounded" Shadow="Shadow.Default">
                        <Div Flex="Flex.Column">
                            <Div Margin="Margin.Is1">
                                <Text TextSize="TextSize.Medium">Название</Text>
                                <Div Padding="Padding.Is2">
                                    <TextEdit @bind-Text="_filter.Name" @onkeyup="OnSearchTextChanged" Placeholder="Введите название..." />
                                </Div>
                            </Div>

                            <Div Margin="Margin.Is1">
                                <Text TextSize="TextSize.Medium">Тег</Text>
                                <Select TValue="string" @bind-SelectedValue="_filter.Tag" @bind-SelectedValue:after="OnTagChanged">
                                    <SelectItem TValue="string" Value="@string.Empty">Все</SelectItem>
                                    @foreach (var tag in _availableTags)
                                    {
                                        <SelectItem TValue="string" Value="@tag">@tag</SelectItem>
                                    }
                                </Select>
                            </Div>

                            <Div Margin="Margin.Is2" Flex="Flex.AlignContent.Center.JustifyContent.Center">
                                <Button Color="Color.Success" Shadow="Shadow.Default" @onclick="Search">Поиск</Button>
                            </Div>
                        </Div>
                    </Div>
                </Column>
            </Row>
        </Column>
    </Row>
</Container>

@code
{
    private IEnumerable<PageDto> _pages = new List<PageDto>();
    private readonly PageFilterDto _filter = new();
    private IEnumerable<string> _availableTags = new List<string>();
    private bool _isLoading = false;
    
    // Пагинация
    private int _currentPage = 1;
    private int _totalPages = 0;
    private int _totalResults = 0;
    private const int PageSize = 18; // 3 колонки × 6 рядов
    
    private Timer? _searchTimer;
    private const int SearchDelayMs = 500; // Задержка для debounce
    
    // Текущие элементы страницы
    private IEnumerable<PageDto> _currentPageItems => _pages.Skip((_currentPage - 1) * PageSize).Take(PageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadTags();
        await Search();
    }

    private async Task LoadTags()
    {
        try
        {
            _availableTags = await ContentService.GetAllTagsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при загрузке тегов: {ex.Message}");
            _availableTags = new List<string> { "средневековье", "SI-FI", "утилиты", "космос", "графика", "шейдеры", "NPC", "оружие", "техника" };
        }
    }

    private async Task Search()
    {
        _isLoading = true;
        StateHasChanged();
        
        try
        {
            _pages = await ContentService.SearchPagesAsync(_filter.Name, _filter.Tag);
            _totalResults = _pages.Count();
            _totalPages = (int)Math.Ceiling(_totalResults / (double)PageSize);
            
            // Если текущая страница больше общего количества, сбрасываем на первую
            if (_currentPage > _totalPages && _totalPages > 0)
            {
                _currentPage = 1;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при поиске: {ex.Message}");
            _pages = new List<PageDto>();
            _totalResults = 0;
            _totalPages = 0;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSearchTextChanged(KeyboardEventArgs e)
    {
        // Сбрасываем предыдущий таймер
        _searchTimer?.Dispose();
        
        // Создаем новый таймер для выполнения поиска с задержкой
        _searchTimer = new Timer(async _ => 
        {
            await InvokeAsync(async () => 
            {
                _currentPage = 1; // Сброс на первую страницу при новом поиске
                await Search();
            });
        }, null, SearchDelayMs, Timeout.Infinite);
    }

    private async Task OnTagChanged()
    {
        await Search();
    }

    private string GetFormattedDate(DateTime date)
    {
        return date.ToString("dd.MM.yyyy");
    }

    private string GetImageUrl(string? imageUrl)
    {
        return string.IsNullOrEmpty(imageUrl) ? "img/jpg/world.jpg" : imageUrl;
    }

    private string GetDescription(string? description)
    {
        return string.IsNullOrEmpty(description) ? "Описание отсутствует" : description;
    }

    private void ChangePage(int pageNumber)
    {
        if (pageNumber > 0 && pageNumber <= _totalPages)
        {
            _currentPage = pageNumber;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}
